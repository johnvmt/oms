(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.omsoplogsubscriptions = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";!function(t){"use strict";function r(t){var r=t.charCodeAt(0);return r===h||r===u?62:r===c||r===f?63:r<o?-1:r<o+10?r-o+26+26:r<i+26?r-i:r<A+26?r-A+26:void 0}function e(t){function e(t){i[f++]=t}var n,h,c,o,A,i;if(t.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var u=t.length;A="="===t.charAt(u-2)?2:"="===t.charAt(u-1)?1:0,i=new a(3*t.length/4-A),c=A>0?t.length-4:t.length;var f=0;for(n=0,h=0;n<c;n+=4,h+=3)o=r(t.charAt(n))<<18|r(t.charAt(n+1))<<12|r(t.charAt(n+2))<<6|r(t.charAt(n+3)),e((16711680&o)>>16),e((65280&o)>>8),e(255&o);return 2===A?(o=r(t.charAt(n))<<2|r(t.charAt(n+1))>>4,e(255&o)):1===A&&(o=r(t.charAt(n))<<10|r(t.charAt(n+1))<<4|r(t.charAt(n+2))>>2,e(o>>8&255),e(255&o)),i}function n(t){function r(t){return lookup.charAt(t)}function e(t){return r(t>>18&63)+r(t>>12&63)+r(t>>6&63)+r(63&t)}var n,a,h,c=t.length%3,o="";for(n=0,h=t.length-c;n<h;n+=3)a=(t[n]<<16)+(t[n+1]<<8)+t[n+2],o+=e(a);switch(c){case 1:a=t[t.length-1],o+=r(a>>2),o+=r(a<<4&63),o+="==";break;case 2:a=(t[t.length-2]<<8)+t[t.length-1],o+=r(a>>10),o+=r(a>>4&63),o+=r(a<<2&63),o+="="}return o}var a="undefined"!=typeof Uint8Array?Uint8Array:Array,h="+".charCodeAt(0),c="/".charCodeAt(0),o="0".charCodeAt(0),A="a".charCodeAt(0),i="A".charCodeAt(0),u="-".charCodeAt(0),f="_".charCodeAt(0);t.toByteArray=e,t.fromByteArray=n}("undefined"==typeof exports?this.base64js={}:exports);
},{}],2:[function(require,module,exports){
(function (global){
"use strict";function typedArraySupport(){function t(){}try{var e=new Uint8Array(1);return e.foo=function(){return 42},e.constructor=t,42===e.foo()&&e.constructor===t&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(t){return!1}}function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function Buffer(t){return this instanceof Buffer?(Buffer.TYPED_ARRAY_SUPPORT||(this.length=0,this.parent=void 0),"number"==typeof t?fromNumber(this,t):"string"==typeof t?fromString(this,t,arguments.length>1?arguments[1]:"utf8"):fromObject(this,t)):arguments.length>1?new Buffer(t,arguments[1]):new Buffer(t)}function fromNumber(t,e){if(t=allocate(t,e<0?0:0|checked(e)),!Buffer.TYPED_ARRAY_SUPPORT)for(var r=0;r<e;r++)t[r]=0;return t}function fromString(t,e,r){"string"==typeof r&&""!==r||(r="utf8");var n=0|byteLength(e,r);return t=allocate(t,n),t.write(e,r),t}function fromObject(t,e){if(Buffer.isBuffer(e))return fromBuffer(t,e);if(isArray(e))return fromArray(t,e);if(null==e)throw new TypeError("must start with number, buffer, array or string");if("undefined"!=typeof ArrayBuffer){if(e.buffer instanceof ArrayBuffer)return fromTypedArray(t,e);if(e instanceof ArrayBuffer)return fromArrayBuffer(t,e)}return e.length?fromArrayLike(t,e):fromJsonObject(t,e)}function fromBuffer(t,e){var r=0|checked(e.length);return t=allocate(t,r),e.copy(t,0,0,r),t}function fromArray(t,e){var r=0|checked(e.length);t=allocate(t,r);for(var n=0;n<r;n+=1)t[n]=255&e[n];return t}function fromTypedArray(t,e){var r=0|checked(e.length);t=allocate(t,r);for(var n=0;n<r;n+=1)t[n]=255&e[n];return t}function fromArrayBuffer(t,e){return Buffer.TYPED_ARRAY_SUPPORT?(e.byteLength,t=Buffer._augment(new Uint8Array(e))):t=fromTypedArray(t,new Uint8Array(e)),t}function fromArrayLike(t,e){var r=0|checked(e.length);t=allocate(t,r);for(var n=0;n<r;n+=1)t[n]=255&e[n];return t}function fromJsonObject(t,e){var r,n=0;"Buffer"===e.type&&isArray(e.data)&&(r=e.data,n=0|checked(r.length)),t=allocate(t,n);for(var f=0;f<n;f+=1)t[f]=255&r[f];return t}function allocate(t,e){Buffer.TYPED_ARRAY_SUPPORT?(t=Buffer._augment(new Uint8Array(e)),t.__proto__=Buffer.prototype):(t.length=e,t._isBuffer=!0);var r=0!==e&&e<=Buffer.poolSize>>>1;return r&&(t.parent=rootParent),t}function checked(t){if(t>=kMaxLength())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength().toString(16)+" bytes");return 0|t}function SlowBuffer(t,e){if(!(this instanceof SlowBuffer))return new SlowBuffer(t,e);var r=new Buffer(t,e);return delete r.parent,r}function byteLength(t,e){"string"!=typeof t&&(t=""+t);var r=t.length;if(0===r)return 0;for(var n=!1;;)switch(e){case"ascii":case"binary":case"raw":case"raws":return r;case"utf8":case"utf-8":return utf8ToBytes(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return base64ToBytes(t).length;default:if(n)return utf8ToBytes(t).length;e=(""+e).toLowerCase(),n=!0}}function slowToString(t,e,r){var n=!1;if(e|=0,r=void 0===r||r===1/0?this.length:0|r,t||(t="utf8"),e<0&&(e=0),r>this.length&&(r=this.length),r<=e)return"";for(;;)switch(t){case"hex":return hexSlice(this,e,r);case"utf8":case"utf-8":return utf8Slice(this,e,r);case"ascii":return asciiSlice(this,e,r);case"binary":return binarySlice(this,e,r);case"base64":return base64Slice(this,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,e,r);default:if(n)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),n=!0}}function hexWrite(t,e,r,n){r=Number(r)||0;var f=t.length-r;n?(n=Number(n),n>f&&(n=f)):n=f;var i=e.length;if(i%2!==0)throw new Error("Invalid hex string");n>i/2&&(n=i/2);for(var o=0;o<n;o++){var u=parseInt(e.substr(2*o,2),16);if(isNaN(u))throw new Error("Invalid hex string");t[r+o]=u}return o}function utf8Write(t,e,r,n){return blitBuffer(utf8ToBytes(e,t.length-r),t,r,n)}function asciiWrite(t,e,r,n){return blitBuffer(asciiToBytes(e),t,r,n)}function binaryWrite(t,e,r,n){return asciiWrite(t,e,r,n)}function base64Write(t,e,r,n){return blitBuffer(base64ToBytes(e),t,r,n)}function ucs2Write(t,e,r,n){return blitBuffer(utf16leToBytes(e,t.length-r),t,r,n)}function base64Slice(t,e,r){return 0===e&&r===t.length?base64.fromByteArray(t):base64.fromByteArray(t.slice(e,r))}function utf8Slice(t,e,r){r=Math.min(t.length,r);for(var n=[],f=e;f<r;){var i=t[f],o=null,u=i>239?4:i>223?3:i>191?2:1;if(f+u<=r){var s,a,h,c;switch(u){case 1:i<128&&(o=i);break;case 2:s=t[f+1],128===(192&s)&&(c=(31&i)<<6|63&s,c>127&&(o=c));break;case 3:s=t[f+1],a=t[f+2],128===(192&s)&&128===(192&a)&&(c=(15&i)<<12|(63&s)<<6|63&a,c>2047&&(c<55296||c>57343)&&(o=c));break;case 4:s=t[f+1],a=t[f+2],h=t[f+3],128===(192&s)&&128===(192&a)&&128===(192&h)&&(c=(15&i)<<18|(63&s)<<12|(63&a)<<6|63&h,c>65535&&c<1114112&&(o=c))}}null===o?(o=65533,u=1):o>65535&&(o-=65536,n.push(o>>>10&1023|55296),o=56320|1023&o),n.push(o),f+=u}return decodeCodePointsArray(n)}function decodeCodePointsArray(t){var e=t.length;if(e<=MAX_ARGUMENTS_LENGTH)return String.fromCharCode.apply(String,t);for(var r="",n=0;n<e;)r+=String.fromCharCode.apply(String,t.slice(n,n+=MAX_ARGUMENTS_LENGTH));return r}function asciiSlice(t,e,r){var n="";r=Math.min(t.length,r);for(var f=e;f<r;f++)n+=String.fromCharCode(127&t[f]);return n}function binarySlice(t,e,r){var n="";r=Math.min(t.length,r);for(var f=e;f<r;f++)n+=String.fromCharCode(t[f]);return n}function hexSlice(t,e,r){var n=t.length;(!e||e<0)&&(e=0),(!r||r<0||r>n)&&(r=n);for(var f="",i=e;i<r;i++)f+=toHex(t[i]);return f}function utf16leSlice(t,e,r){for(var n=t.slice(e,r),f="",i=0;i<n.length;i+=2)f+=String.fromCharCode(n[i]+256*n[i+1]);return f}function checkOffset(t,e,r){if(t%1!==0||t<0)throw new RangeError("offset is not uint");if(t+e>r)throw new RangeError("Trying to access beyond buffer length")}function checkInt(t,e,r,n,f,i){if(!Buffer.isBuffer(t))throw new TypeError("buffer must be a Buffer instance");if(e>f||e<i)throw new RangeError("value is out of bounds");if(r+n>t.length)throw new RangeError("index out of range")}function objectWriteUInt16(t,e,r,n){e<0&&(e=65535+e+1);for(var f=0,i=Math.min(t.length-r,2);f<i;f++)t[r+f]=(e&255<<8*(n?f:1-f))>>>8*(n?f:1-f)}function objectWriteUInt32(t,e,r,n){e<0&&(e=4294967295+e+1);for(var f=0,i=Math.min(t.length-r,4);f<i;f++)t[r+f]=e>>>8*(n?f:3-f)&255}function checkIEEE754(t,e,r,n,f,i){if(e>f||e<i)throw new RangeError("value is out of bounds");if(r+n>t.length)throw new RangeError("index out of range");if(r<0)throw new RangeError("index out of range")}function writeFloat(t,e,r,n,f){return f||checkIEEE754(t,e,r,4,3.4028234663852886e38,-3.4028234663852886e38),ieee754.write(t,e,r,n,23,4),r+4}function writeDouble(t,e,r,n,f){return f||checkIEEE754(t,e,r,8,1.7976931348623157e308,-1.7976931348623157e308),ieee754.write(t,e,r,n,52,8),r+8}function base64clean(t){if(t=stringtrim(t).replace(INVALID_BASE64_RE,""),t.length<2)return"";for(;t.length%4!==0;)t+="=";return t}function stringtrim(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}function toHex(t){return t<16?"0"+t.toString(16):t.toString(16)}function utf8ToBytes(t,e){e=e||1/0;for(var r,n=t.length,f=null,i=[],o=0;o<n;o++){if(r=t.charCodeAt(o),r>55295&&r<57344){if(!f){if(r>56319){(e-=3)>-1&&i.push(239,191,189);continue}if(o+1===n){(e-=3)>-1&&i.push(239,191,189);continue}f=r;continue}if(r<56320){(e-=3)>-1&&i.push(239,191,189),f=r;continue}r=(f-55296<<10|r-56320)+65536}else f&&(e-=3)>-1&&i.push(239,191,189);if(f=null,r<128){if((e-=1)<0)break;i.push(r)}else if(r<2048){if((e-=2)<0)break;i.push(r>>6|192,63&r|128)}else if(r<65536){if((e-=3)<0)break;i.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;i.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return i}function asciiToBytes(t){for(var e=[],r=0;r<t.length;r++)e.push(255&t.charCodeAt(r));return e}function utf16leToBytes(t,e){for(var r,n,f,i=[],o=0;o<t.length&&!((e-=2)<0);o++)r=t.charCodeAt(o),n=r>>8,f=r%256,i.push(f),i.push(n);return i}function base64ToBytes(t){return base64.toByteArray(base64clean(t))}function blitBuffer(t,e,r,n){for(var f=0;f<n&&!(f+r>=e.length||f>=t.length);f++)e[f+r]=t[f];return f}var base64=require("base64-js"),ieee754=require("ieee754"),isArray=require("isarray");exports.Buffer=Buffer,exports.SlowBuffer=SlowBuffer,exports.INSPECT_MAX_BYTES=50,Buffer.poolSize=8192;var rootParent={};Buffer.TYPED_ARRAY_SUPPORT=void 0!==global.TYPED_ARRAY_SUPPORT?global.TYPED_ARRAY_SUPPORT:typedArraySupport(),Buffer.TYPED_ARRAY_SUPPORT?(Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array):(Buffer.prototype.length=void 0,Buffer.prototype.parent=void 0),Buffer.isBuffer=function(t){return!(null==t||!t._isBuffer)},Buffer.compare=function(t,e){if(!Buffer.isBuffer(t)||!Buffer.isBuffer(e))throw new TypeError("Arguments must be Buffers");if(t===e)return 0;for(var r=t.length,n=e.length,f=0,i=Math.min(r,n);f<i&&t[f]===e[f];)++f;return f!==i&&(r=t[f],n=e[f]),r<n?-1:n<r?1:0},Buffer.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(t,e){if(!isArray(t))throw new TypeError("list argument must be an Array of Buffers.");if(0===t.length)return new Buffer(0);var r;if(void 0===e)for(e=0,r=0;r<t.length;r++)e+=t[r].length;var n=new Buffer(e),f=0;for(r=0;r<t.length;r++){var i=t[r];i.copy(n,f),f+=i.length}return n},Buffer.byteLength=byteLength,Buffer.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?utf8Slice(this,0,t):slowToString.apply(this,arguments)},Buffer.prototype.equals=function(t){if(!Buffer.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===Buffer.compare(this,t)},Buffer.prototype.inspect=function(){var t="",e=exports.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,e).match(/.{2}/g).join(" "),this.length>e&&(t+=" ... ")),"<Buffer "+t+">"},Buffer.prototype.compare=function(t){if(!Buffer.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?0:Buffer.compare(this,t)},Buffer.prototype.indexOf=function(t,e){function r(t,e,r){for(var n=-1,f=0;r+f<t.length;f++)if(t[r+f]===e[n===-1?0:f-n]){if(n===-1&&(n=f),f-n+1===e.length)return r+n}else n=-1;return-1}if(e>2147483647?e=2147483647:e<-2147483648&&(e=-2147483648),e>>=0,0===this.length)return-1;if(e>=this.length)return-1;if(e<0&&(e=Math.max(this.length+e,0)),"string"==typeof t)return 0===t.length?-1:String.prototype.indexOf.call(this,t,e);if(Buffer.isBuffer(t))return r(this,t,e);if("number"==typeof t)return Buffer.TYPED_ARRAY_SUPPORT&&"function"===Uint8Array.prototype.indexOf?Uint8Array.prototype.indexOf.call(this,t,e):r(this,[t],e);throw new TypeError("val must be string, number or Buffer")},Buffer.prototype.get=function(t){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(t)},Buffer.prototype.set=function(t,e){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(t,e)},Buffer.prototype.write=function(t,e,r,n){if(void 0===e)n="utf8",r=this.length,e=0;else if(void 0===r&&"string"==typeof e)n=e,r=this.length,e=0;else if(isFinite(e))e|=0,isFinite(r)?(r|=0,void 0===n&&(n="utf8")):(n=r,r=void 0);else{var f=n;n=e,e=0|r,r=f}var i=this.length-e;if((void 0===r||r>i)&&(r=i),t.length>0&&(r<0||e<0)||e>this.length)throw new RangeError("attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return hexWrite(this,t,e,r);case"utf8":case"utf-8":return utf8Write(this,t,e,r);case"ascii":return asciiWrite(this,t,e,r);case"binary":return binaryWrite(this,t,e,r);case"base64":return base64Write(this,t,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,t,e,r);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var MAX_ARGUMENTS_LENGTH=4096;Buffer.prototype.slice=function(t,e){var r=this.length;t=~~t,e=void 0===e?r:~~e,t<0?(t+=r,t<0&&(t=0)):t>r&&(t=r),e<0?(e+=r,e<0&&(e=0)):e>r&&(e=r),e<t&&(e=t);var n;if(Buffer.TYPED_ARRAY_SUPPORT)n=Buffer._augment(this.subarray(t,e));else{var f=e-t;n=new Buffer(f,void 0);for(var i=0;i<f;i++)n[i]=this[i+t]}return n.length&&(n.parent=this.parent||this),n},Buffer.prototype.readUIntLE=function(t,e,r){t|=0,e|=0,r||checkOffset(t,e,this.length);for(var n=this[t],f=1,i=0;++i<e&&(f*=256);)n+=this[t+i]*f;return n},Buffer.prototype.readUIntBE=function(t,e,r){t|=0,e|=0,r||checkOffset(t,e,this.length);for(var n=this[t+--e],f=1;e>0&&(f*=256);)n+=this[t+--e]*f;return n},Buffer.prototype.readUInt8=function(t,e){return e||checkOffset(t,1,this.length),this[t]},Buffer.prototype.readUInt16LE=function(t,e){return e||checkOffset(t,2,this.length),this[t]|this[t+1]<<8},Buffer.prototype.readUInt16BE=function(t,e){return e||checkOffset(t,2,this.length),this[t]<<8|this[t+1]},Buffer.prototype.readUInt32LE=function(t,e){return e||checkOffset(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},Buffer.prototype.readUInt32BE=function(t,e){return e||checkOffset(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},Buffer.prototype.readIntLE=function(t,e,r){t|=0,e|=0,r||checkOffset(t,e,this.length);for(var n=this[t],f=1,i=0;++i<e&&(f*=256);)n+=this[t+i]*f;return f*=128,n>=f&&(n-=Math.pow(2,8*e)),n},Buffer.prototype.readIntBE=function(t,e,r){t|=0,e|=0,r||checkOffset(t,e,this.length);for(var n=e,f=1,i=this[t+--n];n>0&&(f*=256);)i+=this[t+--n]*f;return f*=128,i>=f&&(i-=Math.pow(2,8*e)),i},Buffer.prototype.readInt8=function(t,e){return e||checkOffset(t,1,this.length),128&this[t]?(255-this[t]+1)*-1:this[t]},Buffer.prototype.readInt16LE=function(t,e){e||checkOffset(t,2,this.length);var r=this[t]|this[t+1]<<8;return 32768&r?4294901760|r:r},Buffer.prototype.readInt16BE=function(t,e){e||checkOffset(t,2,this.length);var r=this[t+1]|this[t]<<8;return 32768&r?4294901760|r:r},Buffer.prototype.readInt32LE=function(t,e){return e||checkOffset(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},Buffer.prototype.readInt32BE=function(t,e){return e||checkOffset(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},Buffer.prototype.readFloatLE=function(t,e){return e||checkOffset(t,4,this.length),ieee754.read(this,t,!0,23,4)},Buffer.prototype.readFloatBE=function(t,e){return e||checkOffset(t,4,this.length),ieee754.read(this,t,!1,23,4)},Buffer.prototype.readDoubleLE=function(t,e){return e||checkOffset(t,8,this.length),ieee754.read(this,t,!0,52,8)},Buffer.prototype.readDoubleBE=function(t,e){return e||checkOffset(t,8,this.length),ieee754.read(this,t,!1,52,8)},Buffer.prototype.writeUIntLE=function(t,e,r,n){t=+t,e|=0,r|=0,n||checkInt(this,t,e,r,Math.pow(2,8*r),0);var f=1,i=0;for(this[e]=255&t;++i<r&&(f*=256);)this[e+i]=t/f&255;return e+r},Buffer.prototype.writeUIntBE=function(t,e,r,n){t=+t,e|=0,r|=0,n||checkInt(this,t,e,r,Math.pow(2,8*r),0);var f=r-1,i=1;for(this[e+f]=255&t;--f>=0&&(i*=256);)this[e+f]=t/i&255;return e+r},Buffer.prototype.writeUInt8=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[e]=255&t,e+1},Buffer.prototype.writeUInt16LE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):objectWriteUInt16(this,t,e,!0),e+2},Buffer.prototype.writeUInt16BE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):objectWriteUInt16(this,t,e,!1),e+2},Buffer.prototype.writeUInt32LE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t):objectWriteUInt32(this,t,e,!0),e+4},Buffer.prototype.writeUInt32BE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):objectWriteUInt32(this,t,e,!1),e+4},Buffer.prototype.writeIntLE=function(t,e,r,n){if(t=+t,e|=0,!n){var f=Math.pow(2,8*r-1);checkInt(this,t,e,r,f-1,-f)}var i=0,o=1,u=t<0?1:0;for(this[e]=255&t;++i<r&&(o*=256);)this[e+i]=(t/o>>0)-u&255;return e+r},Buffer.prototype.writeIntBE=function(t,e,r,n){if(t=+t,e|=0,!n){var f=Math.pow(2,8*r-1);checkInt(this,t,e,r,f-1,-f)}var i=r-1,o=1,u=t<0?1:0;for(this[e+i]=255&t;--i>=0&&(o*=256);)this[e+i]=(t/o>>0)-u&255;return e+r},Buffer.prototype.writeInt8=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),t<0&&(t=255+t+1),this[e]=255&t,e+1},Buffer.prototype.writeInt16LE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):objectWriteUInt16(this,t,e,!0),e+2},Buffer.prototype.writeInt16BE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):objectWriteUInt16(this,t,e,!1),e+2},Buffer.prototype.writeInt32LE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24):objectWriteUInt32(this,t,e,!0),e+4},Buffer.prototype.writeInt32BE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):objectWriteUInt32(this,t,e,!1),e+4},Buffer.prototype.writeFloatLE=function(t,e,r){return writeFloat(this,t,e,!0,r)},Buffer.prototype.writeFloatBE=function(t,e,r){return writeFloat(this,t,e,!1,r)},Buffer.prototype.writeDoubleLE=function(t,e,r){return writeDouble(this,t,e,!0,r)},Buffer.prototype.writeDoubleBE=function(t,e,r){return writeDouble(this,t,e,!1,r)},Buffer.prototype.copy=function(t,e,r,n){if(r||(r=0),n||0===n||(n=this.length),e>=t.length&&(e=t.length),e||(e=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),t.length-e<n-r&&(n=t.length-e+r);var f,i=n-r;if(this===t&&r<e&&e<n)for(f=i-1;f>=0;f--)t[f+e]=this[f+r];else if(i<1e3||!Buffer.TYPED_ARRAY_SUPPORT)for(f=0;f<i;f++)t[f+e]=this[f+r];else t._set(this.subarray(r,r+i),e);return i},Buffer.prototype.fill=function(t,e,r){if(t||(t=0),e||(e=0),r||(r=this.length),r<e)throw new RangeError("end < start");if(r!==e&&0!==this.length){if(e<0||e>=this.length)throw new RangeError("start out of bounds");if(r<0||r>this.length)throw new RangeError("end out of bounds");var n;if("number"==typeof t)for(n=e;n<r;n++)this[n]=t;else{var f=utf8ToBytes(t.toString()),i=f.length;for(n=e;n<r;n++)this[n]=f[n%i]}return this}},Buffer.prototype.toArrayBuffer=function(){if("undefined"!=typeof Uint8Array){if(Buffer.TYPED_ARRAY_SUPPORT)return new Buffer(this).buffer;for(var t=new Uint8Array(this.length),e=0,r=t.length;e<r;e+=1)t[e]=this[e];return t.buffer}throw new TypeError("Buffer.toArrayBuffer not supported in this browser")};var BP=Buffer.prototype;Buffer._augment=function(t){return t.constructor=Buffer,t._isBuffer=!0,t._set=t.set,t.get=BP.get,t.set=BP.set,t.write=BP.write,t.toString=BP.toString,t.toLocaleString=BP.toString,t.toJSON=BP.toJSON,t.equals=BP.equals,t.compare=BP.compare,t.indexOf=BP.indexOf,t.copy=BP.copy,t.slice=BP.slice,t.readUIntLE=BP.readUIntLE,t.readUIntBE=BP.readUIntBE,t.readUInt8=BP.readUInt8,t.readUInt16LE=BP.readUInt16LE,t.readUInt16BE=BP.readUInt16BE,t.readUInt32LE=BP.readUInt32LE,t.readUInt32BE=BP.readUInt32BE,t.readIntLE=BP.readIntLE,t.readIntBE=BP.readIntBE,t.readInt8=BP.readInt8,t.readInt16LE=BP.readInt16LE,t.readInt16BE=BP.readInt16BE,t.readInt32LE=BP.readInt32LE,t.readInt32BE=BP.readInt32BE,t.readFloatLE=BP.readFloatLE,t.readFloatBE=BP.readFloatBE,t.readDoubleLE=BP.readDoubleLE,t.readDoubleBE=BP.readDoubleBE,t.writeUInt8=BP.writeUInt8,t.writeUIntLE=BP.writeUIntLE,t.writeUIntBE=BP.writeUIntBE,t.writeUInt16LE=BP.writeUInt16LE,t.writeUInt16BE=BP.writeUInt16BE,t.writeUInt32LE=BP.writeUInt32LE,t.writeUInt32BE=BP.writeUInt32BE,t.writeIntLE=BP.writeIntLE,t.writeIntBE=BP.writeIntBE,t.writeInt8=BP.writeInt8,t.writeInt16LE=BP.writeInt16LE,t.writeInt16BE=BP.writeInt16BE,t.writeInt32LE=BP.writeInt32LE,t.writeInt32BE=BP.writeInt32BE,t.writeFloatLE=BP.writeFloatLE,t.writeFloatBE=BP.writeFloatBE,t.writeDoubleLE=BP.writeDoubleLE,t.writeDoubleBE=BP.writeDoubleBE,t.fill=BP.fill,t.inspect=BP.inspect,t.toArrayBuffer=BP.toArrayBuffer,t};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g;
}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})

},{"base64-js":1,"ieee754":22,"isarray":3}],3:[function(require,module,exports){
var toString={}.toString;module.exports=Array.isArray||function(r){return"[object Array]"==toString.call(r)};
},{}],4:[function(require,module,exports){
var getBSONType=require("./lib/GetBSONType"),MatchQuery=require("./lib/MatchQuery"),Update=require("./lib/Update"),Merge=require("./lib/Merge"),Project=require("./lib/Project"),Aggregate=require("./lib/Aggregate"),FauxmongoError=require("./lib/FauxmongoError");module.exports.matchQuery=MatchQuery,module.exports.update=Update,module.exports.merge=Merge,module.exports.project=Project,module.exports.aggregate=Aggregate,module.exports.FauxmongoError=FauxmongoError,module.exports.getBSONType=getBSONType,module.exports.resolveDollar=Update.resolveDollar;
},{"./lib/Aggregate":5,"./lib/FauxmongoError":8,"./lib/GetBSONType":9,"./lib/MatchQuery":12,"./lib/Merge":13,"./lib/Project":15,"./lib/Update":20}],5:[function(require,module,exports){
function aggregate(r,e,a){var t;a&&(t=[]);for(var o in e){var g,n=e[o];try{g=Object.keys(n)[0]}catch(r){continue}if("$out"==g){if(o!=e.length-1)throw new FauxmongoError("INVALID","found an $out stage that was not the final stage");break}var u=n[g];if(!Object.hasOwnProperty.call(StageOperators,g))throw new FauxmongoError("INVALID","unknown operator",{operator:g});r=StageOperators[g](r,u),a&&t.push(r)}return a?t:r}var StageOperators=require("./AggregationStages"),evaluate=require("./AggregationOperators").evaluate,getTypeStr=require("./GetTypeStr"),FauxmongoError=require("./FauxmongoError");module.exports=aggregate,aggregate.evaluateExpression=evaluate;
},{"./AggregationOperators":6,"./AggregationStages":7,"./FauxmongoError":8,"./GetTypeStr":10}],6:[function(require,module,exports){
function evaluate(e,r){var t=getTypeStr(e);if("string"==t){if("$"==e[0]){if("$"==e[1]){var a=e.slice(2);if(Object.hasOwnProperty.call(r,a))return r[a];throw new FauxmongoError("INVALID","variable "+e+" not found")}var n=r.CURRENT,o=e.slice(1).split(".");for(var u in o){var i=o[u];if(!Object.hasOwnProperty.call(n,i))return;n=n[i]}return n}return e}if("object"==t){var l=Object.keys(e)[0];if("$"!=l[0]){var s={};for(var l in e)s[l]=evaluate(e[l],r);return s}if("$literal"==l)return e.$literal;if("$let"==l){var f={},c=e.$let;for(var v in c.vars)Object.hasOwnProperty.call(r,v)&&(f[v]=r[v]),r[v]=evaluate(c.vars[v],r);var p=evaluate(c.in,r);for(var v in c.vars)Object.hasOwnProperty.call(f,v)?r[v]=f[v]:delete r[v];return p}if("$map"==l){var c=e.$map,f=Object.hasOwnProperty.call(r,c.as)?r[c.as]:void 0,w=evaluate(c.input,r);if(!(w instanceof Array))throw new Error("$map requires an Array input");var $=[];for(var u in w)r[c.as]=w[u],$.push(evaluate(c.in,r));return void 0!==f?r[c.as]=f:delete r[c.as],$}if(!Object.hasOwnProperty.call(AggregationOperators,l))throw new Error("unknown aggregation operator "+l);return AggregationOperators[l](e[l],r)}return e}var getTypeStr=require("./GetTypeStr"),getBSONType=require("./GetBSONType"),matchLeaves=require("./MatchQuery").matchLeaves,Sorting=require("./Sorting"),leafSorter=Sorting.getLeafsort(1),Set=require("./Set"),FauxmongoError=require("./FauxmongoError"),AggregationOperators={$and:function(e,r){for(var t in e)if(!evaluate(e[t],r))return!1;return!0},$or:function(e,r){for(var t in e)if(!evaluate(e[t],r))return!0;return!1},$not:function(e,r){return!Boolean(evaluate(e[0],r))},$allElementsTrue:function(e,r){e=e[0];var t=evaluate(e,r);if(!(t instanceof Array))throw new Error("$allElementsTrue requires an Array");for(var a in t)if(!t[a])return!1;return!0},$anyElementTrue:function(e,r){e=e[0];var t=evaluate(e,r);if(!(t instanceof Array))throw new Error("$anyElementTrue requires an Array");for(var a in t)if(t[a])return!0;return!1},$setDifference:function(e,r){var t=new Set(evaluate(e[0],r)),a=new Set(evaluate(e[1],r));return t.difference(a),t.export()},$setEquals:function(e,r){var t=[];for(var a in e){var n=evaluate(e[a],r);if(!(n instanceof Array))throw new Error("$setEquals only accepts Arrays");t.push(new Set(n))}if(t.length<2)throw new Error("$setEquals requires at least 2 sets");for(var o=t[1],a=1,u=t.length;a<u;a++)if(!o.equals(t[a]))return!1;return!0},$setIntersection:function(e,r){var t=[];for(var a in e){var n=evaluate(e[a],r);if(!(n instanceof Array))throw new Error("$setIntersection only accepts Arrays");t.push(new Set(n))}if(t.length<2)throw new Error("$setIntersection requires at least 2 sets");for(var o=t[0],a=1,u=t.length;a<u;a++)o=o.intersect(t[a]);return o.export()},$setIsSubset:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);if(!(t instanceof Array&&a instanceof Array))throw new FauxmongoError("FORMAT","$setIsSubset only accepts Arrays");return t=new Set(t),a=new Set(a),a.contains(t)},$setUnion:function(e,r){var t=[];for(var a in e)t.push(new Set(evaluate(e[a],r)));if(t.length<2)throw new Error("$setIntersection requires at least 2 sets");for(var n=t[0],a=1,o=t.length;a<o;a++)n.union(t[a]);return n.export()},$cmp:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return leafSorter(t,a)},$eq:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return matchLeaves(t,a)},$gt:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return leafSorter(t,a)>0},$gte:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return leafSorter(t,a)>=0},$lt:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return leafSorter(t,a)<0},$lte:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return leafSorter(t,a)<=0},$ne:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return!matchLeaves(t,a)},$add:function(e,r){var t=[],a=!1;for(var n in e){var o=evaluate(e[n],r),u=typeof o;if("date"==u){if(a)throw new Error("$add accepts at most 1 Date");a=o}else{if("number"!=u)throw new Error("$add only accepts Numbers and Dates");t.push(o)}}if(a){var i=a.getTime();for(var n in t)i+=t[n];return a.setTime(i),a}var l=0;for(var n in t)l+=t[n];return l},$divide:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);if("number"!=typeof t||"number"!=typeof a)throw new Error("$divide only accepts Numbers");return t/a},$mod:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);if("number"!=typeof t||"number"!=typeof a)throw new Error("$divide only accepts Numbers");return t%a},$multiply:function(e,r){var t=[];for(var a in e){var n=evaluate(e[a],r);if("number"!=typeof n)throw new Error("$multiply only accepts Numbers");t.push(n)}var o=1;for(var a in t)o*=t[a];return o},$subtract:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);if("number"!=typeof t||"number"!=typeof a)throw new Error("$divide only accepts Numbers");return t-a},$concat:function(e,r){var t=[];for(var a in e){var n=evaluate(e[a],r);if("string"!=typeof n){if(null===n||void 0===n)return null;throw new Error("$multiply only accepts Numbers")}t.push(n)}if(t.length<2)throw new Error("$concat requires at least 2 arguments");return String.prototype.concat.apply("",t)},$strcasecmp:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);if("string"!=typeof t||"string"!=typeof a)throw new Error("$strcasecmp only accepts Strings");return t=t.toUpperCase(),a=a.toUpperCase(),t==a?0:t<a?-1:1},$substr:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r),n=evaluate(e[2],r);if("string"!=typeof t||"number"!=typeof a||"number"!=typeof n)throw new Error("invalid arguments to $substr");return a<0?"":n<0?t.slice(a):t.slice(a,a+n)},$toLower:function(e,r){var t=evaluate(e,r);if(null===t)return"";if("string"!=typeof t)throw new Error("$toLower only accepts Strings");return t.toLowerCase()},$toUpper:function(e,r){var t=evaluate(e,r);if(null===t)return"";if("string"!=typeof t)throw new Error("$toUpper only accepts Strings");return t.toUpperCase()},$meta:function(e,r){throw new Error("$meta not supported")},$size:function(e,r){var t=evaluate(e,r);if(!(t instanceof Array))throw new Error("$size only accepts Arrays");return t.length},$dayOfMonth:function(e,r){if(e=evaluate(e,r),!(e instanceof Date))throw new Error("$dayOfMonth only accepts Dates");return e.getDate()},$dayOfWeek:function(e,r){if(e=evaluate(e,r),!(e instanceof Date))throw new Error("$dayOfWeek only accepts Dates");return e.getDay()%7+1},$dayOfYear:function(e,r){if(e=evaluate(e,r),!(e instanceof Date))throw new Error("$dayOfYear only accepts Dates");var t=new Date(e.getFullYear(),0,0),a=e-t;return Math.floor(a/864e5)},$hour:function(e,r){if(e=evaluate(e,r),!(e instanceof Date))throw new Error("$hour only accepts Dates");return e.getHours()},$millisecond:function(e,r){if(e=evaluate(e,r),!(e instanceof Date))throw new Error("$millisecond only accepts Dates");return e.getMilliseconds()},$minute:function(e,r){if(e=evaluate(e,r),!(e instanceof Date))throw new Error("$minute only accepts Dates");return e.getMinutes()},$month:function(e,r){if(e=evaluate(e,r),!(e instanceof Date))throw new Error("$month only accepts Dates");return e.getMonth()+1},$second:function(e,r){if(e=evaluate(e,r),!(e instanceof Date))throw new Error("$second only accepts Dates");return e.getSeconds()},$week:function(e,r){if(e=evaluate(e,r),!(e instanceof Date))throw new Error("$week only accepts Dates");var t=new Date(e.getTime()),a=(e.getDay()+6)%7;t.setDate(t.getDate()-a-1);var n=t.getTime();return t.setMonth(0,1),a=t.getDay(),7!=a&&t.setMonth(0,7-a),1+Math.ceil((t.getTime()-n)/6048e5)},$year:function(e,r){if(e=evaluate(e,r),!(e instanceof Date))throw new Error("$year only accepts Dates");return e.getFullYear()},$cond:function(e,r){var t,a,n;if(e instanceof Array)t=e[0],a=e[1],n=e[2];else{if("object"!=typeof e)throw new Error("$cond requires either an Object or Array of arguments");t=e.if,a=e.then,n=e.else}return evaluate(t,r)===!0?evaluate(a,r):evaluate(n,r)},$ifNull:function(e,r){var t=evaluate(e[0],r);return null===t?evaluate(e[1],r):t}},AggregationAccumulators={$addToSet:function(e,r){var t=new Set;for(var a in r)t.add(evaluate(e,{CURRENT:r[a]}));return t.export()},$avg:function(e,r){var t=0,a=0;for(var n in r){var o=evaluate(e,{CURRENT:r[n]});if("number"!=typeof o)throw new FauxmongoError("FORMAT","$sum only accepts numbers");a+=o,t++}return a/t},$first:function(e,r){return evaluate(e,{CURRENT:r[0]})},$last:function(e,r){return evaluate(e,{CURRENT:r[r.length-1]})},$max:function(e,r){for(var t=evaluate(e,{CURRENT:r[0]}),a=1,n=r.length;a<n;a++){var o=evaluate(e,{CURRENT:r[a]});leafSorter(o,t)>0&&(t=o)}return t},$min:function(e,r){for(var t=evaluate(e,{CURRENT:r[0]}),a=1,n=r.length;a<n;a++){var o=evaluate(e,{CURRENT:r[a]});leafSorter(o,t)<0&&(t=o)}return t},$push:function(e,r){var t=[];for(var a in r)t.push(evaluate(e,{CURRENT:r[a]}));return t},$sum:function(e,r){var t=0;for(var a in r){var n=evaluate(e,{CURRENT:r[a]});if("number"!=typeof n)throw new FauxmongoError("FORMAT","$sum only accepts numbers");t+=n}return t}};module.exports.evaluate=evaluate,module.exports.accumulators=AggregationAccumulators;
},{"./FauxmongoError":8,"./GetBSONType":9,"./GetTypeStr":10,"./MatchQuery":12,"./Set":18,"./Sorting":19}],7:[function(require,module,exports){
function clone(r){var e={};for(var o in r){var a=r[o];"object"==typeof a?a instanceof Array?e[o]=cloneArr(a):e[o]=clone(a):e[o]=r[o]}return e}function cloneArr(r){var e=[];for(var o in r){var a=r[o];"object"==typeof a?r instanceof Array?e[o]=clone(a):e[o]=cloneArr(a):e[o]=r[o]}return e}var AggregationOperators=require("./AggregationOperators"),matchQuery=require("./MatchQuery"),project=require("./Project"),Sorting=require("./Sorting"),getTypeStr=require("./GetTypeStr"),FauxmongoError=require("./FauxmongoError"),AggregationStages={$geoNear:function(r,e){throw new FauxmongoError("SUPPORT","$geoNear is not supported")},$group:function(r,e){var o={},a={},t=[],n=[];for(var i in r){var c=r[i],s={CURRENT:c},u=AggregationOperators.evaluate(e._id,s),f=getTypeStr(u);if("string"==f)Object.hasOwnProperty.call(o,u)?o[u].push(c):o[u]=[c];else if("number"==f)Object.hasOwnProperty.call(a,u)?a[u].push(c):a[u]=[c];else{var v=!1;for(var i in t)if(matchQuery.matchLeaves(u,t[i])){v=!0,n[i].push(c);break}v||(t.push(u),n.push([c]))}}var p=t,g=n,l=Object.keys(o),h=Object.keys(a);p.push.apply(p,l),p.push.apply(p,h);for(var i in l)g.push(o[l[i]]);for(var i in h)g.push(a[h[i]]);var y=[];for(var i in p){var O=p[i],E=g[i],w={_id:O};for(var b in e)if("_id"!=b){var d=e[b],j=Object.keys(d);if(!j.length||!Object.hasOwnProperty.call(AggregationOperators.accumulators,j[0]))throw new FauxmongoError("INVALID","$group found an invalid aggregation spec");Object.hasOwnProperty.call(w,b)?w[b]:void 0;w[b]=AggregationOperators.accumulators[j[0]](d[j[0]],E)}y.push(w)}return y},$limit:function(r,e){return r.slice(0,e)},$match:function(r,e){for(var o=[],a=0,t=r.length;a<t;a++)matchQuery(r[a],e)&&o.push(r[a]);return o},$project:function(r,e){var o=[];for(var a in r){var t=r[a],n={CURRENT:t},i=!1,c=!1,s={};for(var u in e){if("_id"==u){var f=e[u];if(0===f||f===!1)continue}var v=e[u];if("object"!=typeof v||v instanceof Array){var p,g=1!==v&&v!==!0,l=r[a],h=s,y=u.split(".");if(y.length>1&&i)throw new FauxmongoError("$project cannot combine dot-notation and layered spec","INVALID");c=!0;for(var O=!1,E=0,w=y.length-1;E<w;E++){var b=y[E];if(Object.hasOwnProperty.call(l,b))l=l[b];else if(!g){O=!0;break}Object.hasOwnProperty.call(h,b)||(l[b]instanceof Array?h[b]=[]:h[b]={}),h=h[b]}O||(p=y[y.length-1],g?h[p]=AggregationOperators.evaluate(v,n):Object.hasOwnProperty.call(l,p)&&(h[p]=l[p]))}else{var d=Object.keys(v);if(d[0]&&"$"==d[0][0]){s[u]=evaluate(v,n);continue}if(c)throw new FauxmongoError("INVALID","$project cannot combine dot-notation and layered spec");i=!0;var j=Object.hasOwnProperty.call(t,u)?t[u]:void 0,A=function r(e,o){var a={},t=!1;for(var i in o){var c=o[i];if("object"!=typeof c||c instanceof Array)1===c||c===!0?e&&Object.hasOwnProperty.call(e,i)&&(a[i]=e[i],t=!0):(a[i]=AggregationOperators.evaluate(c,n),t=!0);else{var s=Object.keys(c);if(s[0]&&"$"==s[0][0])a[i]=AggregationOperators.evaluate(c,n),t=!0;else for(var u in s){var f=s[u],v=e&&Object.hasOwnProperty.call(e,f)?e[f]:void 0,p=r(v,c[f],a[f]={});void 0!==p&&(t=!0,a[f]=p)}}}if(t)return a}(j,v);void 0!==A&&(s[u]=A)}}o.push(s)}return o},$redact:function(r,e){var o=[];for(var a in r){var t=r[a],n={CURRENT:t,DESCEND:{},KEEP:{},PRUNE:{}},i=AggregationOperators.evaluate(e,n);if(i!==n.PRUNE)if(i!==n.KEEP){if(i!==n.DESCEND)throw new FauxmongoError("INVALID","$redact expects one of $$PRUNE, $$KEEP, $$DESCEND");newDoc={};for(var c in t){var s=t[c];if("object"==typeof s){var u=function r(o){if(o instanceof Array){var a=[];for(var t in o){var i=o[t];if("object"!=typeof i)a.push(i);else{var c=r(i);void 0!==c&&a.push(c)}}if(a.length)return a}else{n.CURRENT=o;var s=AggregationOperators.evaluate(e,n);if(s!==n.PRUNE){if(s===n.KEEP)return o;if(s!==n.DESCEND)throw new FauxmongoError("INVALID","$redact expects one of $$PRUNE, $$KEEP, $$DESCEND");var a={},u=Object.keys(o);for(var t in u){var f=u[t],i=o[f];if("object"!=typeof i)a[f]=i;else{var c=r(i);void 0!==c&&(a[f]=c)}}return Object.keys(a).length?a:void 0}}}(s,newDoc,c);void 0!==u&&(newDoc[c]=u)}else newDoc[c]=t[c]}o.push(newDoc)}else o.push(t)}return o},$skip:function(r,e){return r.slice(e)},$sort:function(r,e){var o=[];return o.push.apply(o,r),o.sort(Sorting.getDocsort(e)),o},$unwind:function(r,e){for(var o=[],a=e.slice(1).split("."),t=0,n=r.length;t<n;t++){var i=r[t],c=r[t],s=!1;for(var u in a){var f=a[u];if(!Object.hasOwnProperty.call(c,f)){s=!0;break}if(c=c[f],"object"!=typeof c)throw new FauxmongoError("FORMAT","$unwind found something other than an Array")}if(!s){if(!(c instanceof Array))throw new FauxmongoError("FORMAT","$unwind found something other than an Array");var v=[];for(var u in c){newDoc=clone(i);for(var p=newDoc,g=0,l=a.length-1;g<l;g++)p=p[a[g]];p[a[a.length-1]]=c[u],v.push(newDoc)}o.push.apply(o,v)}}return o}};module.exports=AggregationStages;
},{"./AggregationOperators":6,"./FauxmongoError":8,"./GetTypeStr":10,"./MatchQuery":12,"./Project":15,"./Sorting":19}],8:[function(require,module,exports){
function FauxmongoError(r,o,i){if(Error.call(this),this.code=r,this.message=o,i)for(var t in i)this[t]=i[t]}var util=require("util");util.inherits(FauxmongoError,Error),module.exports=FauxmongoError;
},{"util":26}],9:[function(require,module,exports){
function getBSONType(S,E){var N=getTypeStr(S);return"number"==N?E?1:Math.round(S)==S?16:1:BSON_TYPES.hasOwnProperty(N)?BSON_TYPES[N]:0}var BSON_TYPES={};BSON_TYPES.DOUBLE=1,BSON_TYPES.STRING=2,BSON_TYPES.OBJECT=3,BSON_TYPES.ARRAY=4,BSON_TYPES.BUFFER=5,BSON_TYPES.UNDEFINED=6,BSON_TYPES.OBJECT_ID=7,BSON_TYPES.BOOLEAN=8,BSON_TYPES.DATE=9,BSON_TYPES.NULL=10,BSON_TYPES.REGEXP=11,BSON_TYPES.FUNCTION=13,BSON_TYPES.INTEGER=16,BSON_TYPES.LONG=18,module.exports.BSON_TYPES=BSON_TYPES,module.exports=getBSONType;
},{}],10:[function(require,module,exports){
(function (Buffer){
function getTypeStr(e){var t=typeGetter.apply(e).slice(8,-1).toLowerCase();return"object"==t?e instanceof Buffer?"buffer":t:"text"==t?"textnode":"comment"==t?"commentnode":"html"==t.slice(0,4)?"element":t}var typeGetter={}.toString;try{Buffer}catch(e){Buffer=function(){}}module.exports=getTypeStr;
}).call(this,require("buffer").Buffer)

},{"buffer":2}],11:[function(require,module,exports){
function matchLeaves(e,r){if(e===r)return!0;var t=getTypeStr(e),a=getTypeStr(r);if(t!=a)return!1;if("array"==t){if(e.length!=r.length)return!1;for(var n in e)if(!matchLeaves(e[n],r[n]))return!1;return!0}if("object"==t){var i=Object.keys(e);if(i.length!=Object.keys(r).length)return!1;for(var n in i){var u=i[n];if(!Object.hasOwnProperty.call(r,u)||!matchLeaves(e[u],r[u]))return!1}return!0}return!1}var getTypeStr=require("./GetTypeStr");module.exports=matchLeaves;
},{"./GetTypeStr":10}],12:[function(require,module,exports){
function matchQuery(r,e,a){var t=a?a.length:0;for(var i in e){var o=e[i];if(a){if(i.slice(0,t)!=a)continue;i=i.slice(t+1)}if("$where"==i)throw new Error("$where is not supported");var n=getTypeStr(o);if("$and"!=i)if("$or"!=i)if("$nor"!=i){if("$"==i[0])return matchSubquery(r,e);for(var f=i.split("."),h=r,u="object",c=!0,s=!1,l=0,y=f.length-1;l<y;l++){var v=f[l];if("$"==v[0])throw new Error("invalid path "+i);if("array"==u){var m=parseInt(v),p=f.slice(l+1).join(".");if(!isNaN(m)&&v.match(/^\d+$/)&&m<h.length){var w={};if(w[p]=o,matchQuery(h[v],w)){s=!0;break}}var b=!1;p=v+"."+p;var w={};w[p]=o;for(var l in h)if(matchQuery(h[l],w)){b=!0;break}if(!b)return!1;s=!0;break}if("object"!=u)throw new Error("Encountered a leaf in the middle of the path "+i);if("$"==v[0])throw new Error("invalid path "+i);if(!Object.hasOwnProperty.call(h,v)){c=!1;break}h=h[v],u=getTypeStr(h)}if(!s){var v=f[f.length-1];if("$"==v[0])throw new Error("invalid path "+i);if("array"==u){var m=parseInt(v),p=f.slice(l+1).join(".");if(!isNaN(m)&&v.match(/^\d+$/)&&m<h.length&&matchLeaves(h[v],o)){s=!0;break}var b=!1,w={};w[v]=o;for(var l in h)if(matchQuery(h[l],w)){b=!0;break}if(!b)return!1;s=!0;break}if("object"!=u)throw new Error("Encountered a leaf in the middle of the path "+i);if(!c||!Object.hasOwnProperty.call(h,v)){if("object"==n&&Object.hasOwnProperty.call(o,"$exists")&&!o.$exists)continue;return!1}if("object"!=n||!moreDollars(o)){if(matchLeaves(h[v],o))continue;return!1}for(var d in o)if("$exists"!=d&&!operators.ops[d](h[v],o[d]))return!1}}else{if("array"!=n)throw new Error("$nor requires an Array of query documents");for(var l=0,y=o.length;l<y;l++)if(matchQuery(r,o[l]))return!1}else{if("array"!=n)throw new Error("$or requires an Array of query documents");for(var b=!1,l=0,y=o.length;l<y;l++)if(matchQuery(r,o[l])){b=!0;break}if(!b)return!1}else{if("array"!=n)throw new Error("$and requires an Array of query documents");for(var l=0,y=o.length;l<y;l++)if(!matchQuery(r,o[l]))return!1}}return!0}function matchSubquery(r,e){for(var a in e)if("$exists"!=a&&!operators.ops[a](r,e[a]))return!1;return!0}module.exports=matchQuery,matchQuery.matchSubquery=matchSubquery;var operators=require("./QueryOperators"),getTypeStr=require("./GetTypeStr"),moreDollars=require("./MoreDollars"),matchLeaves=require("./MatchLeaves");matchQuery.matchLeaves=matchLeaves;
},{"./GetTypeStr":10,"./MatchLeaves":11,"./MoreDollars":14,"./QueryOperators":16}],13:[function(require,module,exports){
function simpleMerge(e,r){for(var t in e){var i=e[t];if(Object.hasOwnProperty.call(r,t)){var a=getTypeStr(i),l=r[t],o=getTypeStr(l);a==o?"object"==a?simpleMerge(i,l):"array"==a?simpleArrayMerge(i,l):r[t]=i:r[t]=i}else r[t]=i}}function simpleArrayMerge(e,r){for(var t in e){var i=e[t];if(t>=r.length)r.push(i);else{var a=getTypeStr(i),l=r[t],o=getTypeStr(l);a==o?"object"==a?simpleMerge(i,l):"array"==a?simpleArrayMerge(i,l):r[t]=i:r[t]=i}}}function merge(e,r,t,i){function a(e,r,t){for(var i in e){var o=e[i],n=getTypeStr(o),s=t?t+"."+i:i;if(Object.hasOwnProperty.call(r,i)){var c=r[i],p=getTypeStr(c);n==p?"object"==n?a(o,c,s):"array"==n?l(o,c,s):r[i]=o:r[i]=o}else if("array"!=n)r[i]=o;else{var f=r[i]=[];l(o,f,s)}}}function l(e,n,s){if(e.length){if(Object.hasOwnProperty.call(i,s)){var c=i[s];if("object"==typeof c){if(c.$elemMatch){for(var p in n)if(matchQuery(n[p],c.$elemMatch))return void(n[p]=e[0]);return}if(c.$slice){var f,v,y;if("number"==typeof c.$slice){if(c.$slice<0)return;f=0,v=Math.min(e.length,c.$slice)}else{if(c.$slice[0]<0)return;f=c.$slice[0],v=f+c.$slice[1],y=v-f-e.length}for(var p=0,g=f;g<v;g++,p++)n[g]=e[p];return void(y&&n.splice(f+e.length,n.length))}}}else if(Object.hasOwnProperty.call(i,s+".$")){if(o)throw new Error("projection contains more than one positional operator");o=s;var u=resolveDollar(r,t,s.split("."),s);return void(u>=0&&(n[u]=e[0]))}for(var p in e){var h=e[p];if(p>=n.length)n.push(h);else{var m=getTypeStr(h),M=n[p],b=getTypeStr(M);m==b?"object"==m?a(h,M,s):"array"==m?l(h,M,s):n[p]=h:n[p]=h}}}}if(i||(i=t,t=void 0),!i)return simpleMerge(e,r);var o;a(e,r)}var getTypeStr=require("./GetTypeStr"),resolveDollar=require("./ResolveDollar"),matchQuery=require("./MatchQuery");module.exports=merge;
},{"./GetTypeStr":10,"./MatchQuery":12,"./ResolveDollar":17}],14:[function(require,module,exports){
function moreDollars(r,e){if(e){for(var o in r)if(moreDollars(r[o]))return!0;return!1}for(var t in r){if("$"==t[0])return!0;var l=r[t],a=getTypeStr(l);if("object"!=a){if("array"==a&&moreDollars(l,!0))return!0}else if(moreDollars(l))return!0}return!1}var getTypeStr=require("./GetTypeStr");module.exports=moreDollars;
},{"./GetTypeStr":10}],15:[function(require,module,exports){
function project(r,e,a){function o(r,e,a){var i,t=getTypeStr(r);if(e)i=e;else{if("object"!=t){if("array"==t){e=[];var n=a.slice(l);for(var l in r){var s=o(r[l],e[l],n);void 0!==s&&(e[l]=s)}return e}return}e={}}for(var l=0,c=a.length-1;l<c;l++){var f=a[l];if("$"==f)throw new Error("cannot use the positional operator inside another Array");if("array"==t){i||(i=e);var n=a.slice(l);for(var v in r){var s=o(r[v],e[v],n);void 0!==s&&(e[v]=s)}return i}if("object"!=t)return i;if(!Object.hasOwnProperty.call(r,f))return i;i||(i=e),r=r[f],t=getTypeStr(r),e=Object.hasOwnProperty.call(e,f)?e[f]:"object"==t?e[f]={}:e[f]=[]}var y=a[a.length-1];if(i||(i=e),"array"==t){for(var v in r){var s=o(r[v],e[v],[y]);void 0!==s&&(e[v]=s)}return i}return"object"!=t?i:(Object.hasOwnProperty.call(r,y)&&(e[y]=r[y],i||(i=e)),i)}a||(a=e,e=void 0);var i,t,n,l={};for(var s in a){for(var c=a[s],f=r,v=l,y=s.split("."),p=!1,u="object",h=0,w=y.length-1;h<w;h++){if(void 0===f){p=!0;break}if(i&&y.slice(0,h+1).join(".")==i){p=!0;break}var b=y[h];if("$"==b){if("array"!=u)throw new Error("positional operator requires an Array");if(!e)throw new Error("positional operator requires an query");if(i)throw new Error("cannot use the positional operator on more than one Array");var j=y.slice(0,h);i=j.join(".");var $=resolveDollar(r,e,j,i);if($<0){p=!0;break}n[t]=[f[$]],p=!0;break}if("array"==u){var d=y.slice(h);for(var h in f){var O=o(f[h],v[h],d);void 0!==O&&(v[h]=O)}p=!0;break}if(n=v,t=b,f=f[b],u=getTypeStr(f),Object.hasOwnProperty.call(v,b))v=v[b];else if("object"==u)v=v[b]={};else{if("array"!=u){p=!0;break}v=v[b]=[]}}if(!p){var q=y[y.length-1];if("$"!=q)if("array"!=u){if(f=f[q],Object.hasOwnProperty.call(c,"$elemMatch")||Object.hasOwnProperty.call(c,"$slice")){if(f instanceof Array)if(c.$elemMatch){v=v[q]=[];for(var g in f)if(matchQuery(f[g],c.$elemMatch)){v.push(f[g]);break}}else{if(!c.$slice)throw new Error("unsupported query option "+JSON.stringify(c));if(c.$slice instanceof Number)c.$slice>=0?v[q]=f.slice(0,c.$slice):v[q]=f.slice(c.$slice);else if(!(c.$slice instanceof Array))throw new Error("$slice requires an Array of boundary indices");v[q]=f.slice(c.$slice[0],c.$slice[0]+c.$slice[1])}}else if(void 0!==f){var m=getTypeStr(f);if("array"!=m)v[q]=f;else{var E=v[q]=[];E.push.apply(E,f)}}}else for(var h in f){var O=o(f[h],v[h],[q]);void 0!==O&&(v[h]=O)}else{if("array"!=u)throw new Error("positional operator requires an Array");if(!e)throw new Error("positional operator requires an query");if(i)throw new Error("cannot use the positional operator on more than one Array");var j=y.slice(0,h);i=j.join(".");var $=resolveDollar(r,e,j,i);if($<0)continue;n[t]=[f[$]]}}}return l}var getTypeStr=require("./GetTypeStr"),resolveDollar=require("./ResolveDollar"),matchQuery=require("./MatchQuery");module.exports=project;
},{"./GetTypeStr":10,"./MatchQuery":12,"./ResolveDollar":17}],16:[function(require,module,exports){
var getTypeStr=require("./GetTypeStr"),matchLeaves=require("./MatchLeaves"),matchQuery=require("./MatchQuery"),LOOKUP_BSON_TYPE={1:"number",2:"string",3:"object",4:"array",5:"buffer",6:"undefined",8:"boolean",9:"date",10:"null",11:"regexp",13:"function",16:"number",18:"number"},fieldOps={$not:function(r,e){if("object"!=getTypeStr(r))throw new Error("$not requires a query document");return!matchQuery(r,e)},$gt:function(r,e){return!("number"!=typeof r||"number"!=typeof e||r<=e)},$gte:function(r,e){return!("number"!=typeof r||"number"!=typeof e||r<e)},$in:function(r,e){if("array"!=getTypeStr(e))throw new Error("$in requires an Array");var t="string"==typeof r;for(var n in e){var u=e[n];if("regexp"==getTypeStr(u)){if(!t)continue;if(r.match(u))return!0}else if(matchLeaves(u,r))return!0}return!1},$lt:function(r,e){return!("number"!=typeof r||"number"!=typeof e||r>=e)},$lte:function(r,e){return!("number"!=typeof r||"number"!=typeof e||r>e)},$ne:function(r,e){return!matchLeaves(r,e)},$nin:function(r,e){if("array"!=getTypeStr(e))throw new Error("$nin requires an Array");var t="string"==typeof r;for(var n in e){var u=e[n];if("regexp"==getTypeStr(u)){if(!t)continue;if(r.match(u))return!1}else if(matchLeaves(e[n],r))return!1}return!0},$mod:function(r,e){if("array"!=getTypeStr(e)||2!=e.length)throw new Error("$in requires an Array of [ divisor, remainder ]");return"number"==typeof r&&r%e[0]==e[1]},$regex:function(r,e){if("regexp"!=getTypeStr(e))throw new Error("$regex requires a RegExp");return"string"==typeof r&&!!r.match(e)},$type:function(r,e){if("number"!=getTypeStr(e))throw new Error("$type requires a BSON type integer");return!!LOOKUP_BSON_TYPE.hasOwnProperty(e)&&getTypeStr(r)==LOOKUP_BSON_TYPE[e]}},arrOps={$all:function(r,e){if("array"!=getTypeStr(e))throw new Error("$all requires an Array of values");if(!r.length)return!0;var t=[];t.push.apply(t,e);for(var n in r)for(var u=0,o=t.length;u<o;u++)if(matchLeaves(r[n],t[u])&&(t.splice(u,1),u--,o--,!o))return!0;return!1},$elemMatch:function(r,e){if("object"!=getTypeStr(e))throw new Error("$elemMatch requires a query document");for(var t in r)if(matchQuery(r[t],e))return!0;return!1},$size:function(r,e){if("number"!=getTypeStr(e))throw new Error("$size requires an integer");return r.length==e}},ops={};for(var key in fieldOps)ops[key]=fieldOps[key];for(var key in arrOps)ops[key]=arrOps[key];module.exports.ops=ops,module.exports.fieldOps=fieldOps,module.exports.arrOps=arrOps;
},{"./GetTypeStr":10,"./MatchLeaves":11,"./MatchQuery":12}],17:[function(require,module,exports){
function resolveDollar(r,e,a,t){var l=r;for(var c in a)l=l[a[c]];if(!l.length)return-1;var i=t.length,n=-1,f=!1;for(var o in e)if(o.slice(0,i)==t){var v=e[o];if(v instanceof Object&&Object.hasOwnProperty.call(v,"$elemMatch")){for(var c in l)if(matchQuery(l[c],v.$elemMatch)){n=c;break}if(n>=0)return n}else if(!f){var h={};h[o.slice(i+1)]=v;for(var c in l)if(matchQuery(l[c],h)){try{var u=Object.keys(v);u.length&&"$"==u[0][0]&&(f=!0)}catch(r){}n=c;break}}}return n}var matchQuery=require("./MatchQuery");module.exports=resolveDollar;
},{"./MatchQuery":12}],18:[function(require,module,exports){
function Set(t){if(this.strings={},this.nums={},this.others=[],t)for(var r in t){var e=t[r],s=getTypeStr(e);if("string"==s)this.strings[e]=!0;else if("number"==s)this.nums[e]=!0;else{var i=!1;for(var n in this.others)if(matchLeaves(e,this.others[n])){i=!0;break}i||this.others.push(e)}}}var matchLeaves=require("./MatchQuery").matchLeaves,getTypeStr=require("./GetTypeStr");Set.prototype.union=function(t){for(var r in t.strings)this.strings[r]=!0;for(var r in t.nums)this.nums[r]=!0;for(var e in t.others){var s=!1;for(var i in this.others)if(matchLeaves(t.others[e],this.others[i])){s=!0;break}s||this.others.push(t.others[e])}},Set.prototype.difference=function(t){for(var r in t.strings)delete this.strings[r];for(var r in t.nums)delete this.nums[r];for(var e in t.others)for(var s=0,i=this.others.length;s<i;s++)if(matchLeaves(this.others[s],t.others[e])){this.others.splice(s,1),s--,i--;break}},Set.prototype.intersect=function(t){var r=new Set([]);for(var e in t.strings)Object.hasOwnProperty.call(this.strings,e)&&(r.strings[e]=!0);for(var e in t.nums)Object.hasOwnProperty.call(this.nums,e)&&(r.nums[e]=!0);for(var s in t.others)for(var i=0,n=this.others.length;i<n;i++)if(matchLeaves(this.others[i],t.others[s])){r.others.push(this.others[i]);break}return r},Set.prototype.equals=function(t){if(this.others.length!=t.others.length)return!1;var r=Object.keys(this.strings),e=Object.keys(this.nums),s=Object.keys(t.strings),i=Object.keys(t.nums);if(r.length!=s.length||e.length!=i.length)return!1;for(var n in r)if(!Object.hasOwnProperty.call(t.strings,r[n]))return!1;for(var n in e)if(!Object.hasOwnProperty.call(t.nums,e[n]))return!1;for(var n in this.others){var h=!1;for(var o in t.others)if(matchLeaves(t.others[o],this.others[n])){h=!0;break}if(!h)return!1}return!0},Set.prototype.contains=function(t){for(var r in t.strings)if(!Object.hasOwnProperty.call(this.strings,r))return!1;for(var r in t.nums)if(!Object.hasOwnProperty.call(this.nums,r))return!1;for(var e in t.others){var s=!1;for(var i in this.others)if(matchLeaves(this.others[i],t.others[e])){s=!0;break}if(!s)return!1}return!0},Set.prototype.add=function(t){var r=getTypeStr(t);if("string"!=r||Object.hasOwnProperty.call(this.nums,t))if("number"!=r||Object.hasOwnProperty.call(this.nums,String(t))){var e=!1;for(var s in this.others)if(matchLeaves(t,this.others[s])){e=!0;break}if(!e)return this.others.push(t),!0}else this.nums[t]=!0;else this.strings[t]=!0},Set.prototype.export=function(){var t=Object.keys(this.strings);return t.push.apply(t,Object.keys(this.nums).map(Number)),t.push.apply(t,this.others),t},module.exports=Set;
},{"./GetTypeStr":10,"./MatchQuery":12}],19:[function(require,module,exports){
function getLeafsort(r){function e(t,n){if(t===n)return 0;var a=getTypeStr(t),f=getTypeStr(n);if(a!=f)return Math.max(-1,Math.min(1,r*(SORT_PRIORITY[f]-SORT_PRIORITY[a])));if("number"==a)return Math.max(-1,Math.min(1,r*(n-t)));if("string"==a)return n>t?r:-1*r;if("object"==a){var i=Object.keys(t)[0],o=Object.keys(n)[0];for(var u in o){if(i[u]!=o[u])return o[u]>i[u]?r:-1*r;var l=e(t[i[u]],n[i[u]]);if(l)return l}}if("array"==a){if(!a.length)return f.length?1:0;if(!f.length)return a.length?-1:0;if(r>0){for(var h=t[0],R=n[0],u=1,g=t.length;u<g;u++)r*e(h,t[u])>0&&(h=t[u]);for(var u=1,g=n.length;u<g;u++)r*e(R,t[u])>0&&(R=n[u]);return e(h,R)}for(var O=t[0],s=n[0],u=1,g=t.length;u<g;u++)r*e(O,t[u])<0&&(O=t[u]);for(var u=1,g=n.length;u<g;u++)r*e(s,t[u])<0&&(s=n[u]);return e(O,s)}if("buffer"==a){if(t.length!=n.length)return Math.max(-1,Math.min(1,r*(n.length-t.length)));for(var u=0,g=t.length;u<g;u++)if(t[u]!=n[u])return Math.max(-1,Math.min(1,r*(Number(n[u])-Number(t[u]))));return 0}return"boolean"==a?f?r:-1*r:"date"==a?n>t?r:-1*r:0}return r*=-1,e}function getDocsort(r){var e=getLeafsort(1),t=[],n=Object.keys(r);for(var a in r){if(a.match(/\$/))throw new Error("invalid sort path "+a);t.push(a.split("."))}return function(a,f){for(var i in t){var o=t[i],u=a,l=f,h=r[n[i]]>0?1:-1;for(var R in o){var g=o[R];if(Object.hasOwnProperty.call(a,g)){if(Object.hasOwnProperty.call(f,g))u=u[g],l=l[g];else if(Object.hasOwnProperty.call(a,g))return-1*h}else if(Object.hasOwnProperty.call(f,g))return h}var O=h*e(u,l);if(O)return O}return 0}}var getTypeStr=require("./GetTypeStr"),ARR_SORT_PRIORITY=["null","number","string","object","array","buffer","boolean","date","regexp"],SORT_PRIORITY={};for(var i in ARR_SORT_PRIORITY)SORT_PRIORITY[ARR_SORT_PRIORITY[i]]=i;module.exports.getLeafsort=getLeafsort,module.exports.getDocsort=getDocsort;
},{"./GetTypeStr":10}],20:[function(require,module,exports){
function update(r,e,a){if(a||(a=e,e=r,r=void 0),Object.hasOwnProperty.call(a,"$rename"))for(var o in a.$rename){var t,n=e,i=o.split(".");for(var l in i){var s=getTypeStr(n);if("object"!=s&&"array"!=s)throw new Error("cannot traverse data to rename path "+o);var h=i[l];if("$"==h[0])throw new Error("cannot rename dynamic path "+o);if(!Object.hasOwnProperty.call(n,h)){t=!0;break}n=n[h]}if(!t){var p=a.$rename[o];if(Object.hasOwnProperty.call(a,"$set")||(a.$set={}),Object.hasOwnProperty.call(a.$set,p))throw new Error("cannot rename more than one value to the same path "+p);a.$set[p]=n,Object.hasOwnProperty.call(a,"$unset")||(a.$unset={}),a.$unset[o]=!0}}var f,w;for(var c in a){var $=a[c];if(!operators.ops.hasOwnProperty(c))throw new Error("unrecognized operator "+c);if("$rename"!=c&&"$isolated"!=c){var v=STUBBORN_OPS.hasOwnProperty(c);for(var d in $){for(var y=!1,i=d.split("."),n=e,u="object",O=!0,l=0,b=i.length-1;l<b;l++){if("object"!=u&&"array"!=u)throw new Error("Encountered a leaf in the middle of the path "+d);var h=i[l];if("$"!=h){if("$"==h[0])throw new Error("invalid path "+d);if(y)n=n[h]={};else if(Object.hasOwnProperty.call(n,h))n=n[h],u=getTypeStr(n);else{if(!v){O=!1;break}y=!0,n=n[h]={},u="object"}}else{if(y){O=!1;break}if("array"!=u)throw new Error("Found a non-Array ("+u+") at the $ operator in path "+d);if(!l)throw new Error("The path "+d+" is invalid because it begins with the $ operator.");var m=i.slice(0,l),E=m.join(".");if(void 0!==f&&E!=w)throw new Error("The $ operator may only be used on one field (at "+d+")");if(f=m,w=E,h=resolveDollar(e,r,f,w),h<0)continue;n=n[h],u="array"}}if(O){if("object"!=u&&"array"!=u)throw new Error("Encountered a leaf in the middle of the path "+d);var h=i[i.length-1];if("$"==h){if(y)continue;if("array"!=u)throw new Error("Found a non-Array ("+u+") at the $ operator in path "+d);var m=i.slice(0,l),E=m.join(".");if(void 0!==f&&E!=w)throw new Error("The $ operator may only be used on one field (at "+d+")");if(f=m,w=E,h=resolveDollar(e,r,f,w),h<0)continue}else if("$"==h[0])throw new Error("invalid path "+d);if(operators.arrOps.hasOwnProperty(c))if(void 0===n[h]){if(!v)continue;n[h]=[]}else if("array"!=getTypeStr(n[h]))throw new Error("cannot apply "+c+" to non-array value");operators.ops[c](n,h,$[d])}}}}}var MOD_OPS={$each:!0,$position:!0,$slice:!0,$sort:!0},STUBBORN_OPS={$set:!0,$inc:!0,$min:!0,$max:!0,$mul:!0,$currentDate:!0,$addToSet:!0,$push:!0,$pushAll:!0};module.exports=update;var operators=require("./UpdateOperators"),getTypeStr=require("./GetTypeStr"),resolveDollar=require("./ResolveDollar");update.resolveDollar=resolveDollar;
},{"./GetTypeStr":10,"./ResolveDollar":17,"./UpdateOperators":21}],21:[function(require,module,exports){
var getTypeStr=require("./GetTypeStr"),Sorting=require("./Sorting"),moreDollars=require("./MoreDollars"),matchLeaves=require("./MatchLeaves"),matchQuery=require("./MatchQuery"),fieldOps={$set:function(r,e,o){var t=getTypeStr(o);if("object"==t&&moreDollars(o)||"array"==t&&moreDollars(o,!0))throw new Error("invalid property key in complex update");r[e]=o},$inc:function(r,e,o){if("number"!=getTypeStr(o))throw new Error("cannot $inc by a non-numeric value");if(Object.hasOwnProperty.call(r,e)){if("number"!=getTypeStr(r[e]))throw new Error("cannot apply $inc on a non-numeric value");r[e]+=o}else r[e]=o},$min:function(r,e,o){if("number"!=getTypeStr(o))throw new Error("cannot $min to a non-numeric value");if(Object.hasOwnProperty.call(r,e)){if("number"!=getTypeStr(r[e]))throw new Error("cannot apply $min on a non-numeric value");r[e]=Math.min(r[e],o)}else r[e]=o},$max:function(r,e,o){if("number"!=getTypeStr(o))throw new Error("cannot $max to a non-numeric value");if(Object.hasOwnProperty.call(r,e)){if("number"!=getTypeStr(r[e]))throw new Error("cannot apply $max on a non-numeric value");r[e]=Math.max(r[e],o)}else r[e]=o},$mul:function(r,e,o){if("number"!=getTypeStr(o))throw new Error("cannot $mul by a non-numeric value");if(Object.hasOwnProperty.call(r,e)){if("number"!=getTypeStr(r[e]))throw new Error("cannot apply $mul on a non-numeric value");r[e]*=o}else r[e]=0},$bit:function(r,e,o){if("object"!=getTypeStr(o))throw new Error("invalid $bit update");if(Object.hasOwnProperty.call(r,e)){if("number"!=getTypeStr(r[e]))throw new Error("cannot apply $bit on a non-numeric value")}else r[e]=0;for(var t in o){var n=o[t];if("number"!=typeof n)throw new Error("cannot $bit by a non-numeric value");if("and"==t)r[e]&=n;else if("or"==t)r[e]|=n;else{if("xor"!=t)throw new Error("unknown bit operation "+t);r[e]^=n}}},$unset:function(r,e,o){delete r[e]},$currentDate:function(r,e,o){r[e]=new Date},$rename:!0,$isolated:!0},arrOps={$addToSet:function(r,e,o){if(Object.hasOwnProperty.call(o,"$position")||Object.hasOwnProperty.call(o,"$sort")||Object.hasOwnProperty.call(o,"$slice"))throw new Error("Ordering modifiers are not allowed together with $addToSet");if(!Object.hasOwnProperty.call(r,e))return void(r[e]=[o]);var t=r[e];if("object"==getTypeStr(o)&&Object.hasOwnProperty.call(o,"$each"))for(var n in o.$each){var a=o.$each[n],i=!0;for(var l in t)if(matchLeaves(t[l],a)){i=!1;break}i&&t.push(o.$each[n])}else{for(var n in t)if(matchLeaves(t[n],o))return;t.push(o)}},$push:function(r,e,o){var t=getTypeStr(o),n=r[e];if("object"!=t)n.push(o);else if(Object.hasOwnProperty.call(o,"$each")){var a,i=o.$each;if(Object.hasOwnProperty.call(o,"$position")){if(o.$position<0)throw new Error("$position does not accept negative numbers");a=o.$position>=n.length?void 0:o.$position}if(void 0===a)for(var l in i){if(moreDollars(i[l]))throw new Error("invalid property key in complex update");n.push(i[l])}else for(var l in i){if(moreDollars(i[l]))throw new Error("invalid property key in complex update");n.splice(a,0,i[l])}if(Object.hasOwnProperty.call(o,"$sort")){var p=o.$sort;"number"==typeof p?(p=p>0?1:-1,n.sort(Sorting.getLeafsort(p))):n.sort(Sorting.getDocsort(p))}Object.hasOwnProperty.call(o,"$slice")&&(o.$slice<0?r[e]=n.slice(o.$slice):r[e]=n.slice(0,o.$slice))}else moreDollars(o)||n.push(o)},$pop:function(r,e,o){var t=getTypeStr(o);if("number"!=t)throw new Error("$pop requires a number");o>0?arr.pop():o<0&&arr.shift()},$pull:function(r,e,o){var t=r[e],n=getTypeStr(o);if("object"==n)for(var a=0,i=t.length;a<i;a++)matchQuery(t[a],o)&&(t.splice(a,1),a--,i--);else for(var a=0,i=t.length;a<i;a++)matchLeaves(t[a],o)&&(t.splice(a,1),a--,i--)},$pullAll:function(r,e,o){var t=r[e];if("array"!=getTypeStr(o))throw new Error("$pullAll requires an Array of values/documents to match");for(var n in o)for(var a=0,i=t.length;a<i;a++)matchLeaves(t[a],o[n])&&(t.splice(a,1),a--,i--)}},ops={};for(var op in fieldOps)ops[op]=fieldOps[op];for(var op in arrOps)ops[op]=arrOps[op];module.exports.ops=ops,module.exports.fieldOps=fieldOps,module.exports.arrOps=arrOps;
},{"./GetTypeStr":10,"./MatchLeaves":11,"./MatchQuery":12,"./MoreDollars":14,"./Sorting":19}],22:[function(require,module,exports){
exports.read=function(a,o,t,r,h){var M,p,w=8*h-r-1,f=(1<<w)-1,e=f>>1,i=-7,N=t?h-1:0,n=t?-1:1,s=a[o+N];for(N+=n,M=s&(1<<-i)-1,s>>=-i,i+=w;i>0;M=256*M+a[o+N],N+=n,i-=8);for(p=M&(1<<-i)-1,M>>=-i,i+=r;i>0;p=256*p+a[o+N],N+=n,i-=8);if(0===M)M=1-e;else{if(M===f)return p?NaN:(s?-1:1)*(1/0);p+=Math.pow(2,r),M-=e}return(s?-1:1)*p*Math.pow(2,M-r)},exports.write=function(a,o,t,r,h,M){var p,w,f,e=8*M-h-1,i=(1<<e)-1,N=i>>1,n=23===h?Math.pow(2,-24)-Math.pow(2,-77):0,s=r?0:M-1,u=r?1:-1,l=o<0||0===o&&1/o<0?1:0;for(o=Math.abs(o),isNaN(o)||o===1/0?(w=isNaN(o)?1:0,p=i):(p=Math.floor(Math.log(o)/Math.LN2),o*(f=Math.pow(2,-p))<1&&(p--,f*=2),o+=p+N>=1?n/f:n*Math.pow(2,1-N),o*f>=2&&(p++,f/=2),p+N>=i?(w=0,p=i):p+N>=1?(w=(o*f-1)*Math.pow(2,h),p+=N):(w=o*Math.pow(2,N-1)*Math.pow(2,h),p=0));h>=8;a[t+s]=255&w,s+=u,w/=256,h-=8);for(p=p<<h|w,e+=h;e>0;a[t+s]=255&p,s+=u,p/=256,e-=8);a[t+s-u]|=128*l};
},{}],23:[function(require,module,exports){
function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(e){if(cachedSetTimeout===setTimeout)return setTimeout(e,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(e,0);try{return cachedSetTimeout(e,0)}catch(t){try{return cachedSetTimeout.call(null,e,0)}catch(t){return cachedSetTimeout.call(this,e,0)}}}function runClearTimeout(e){if(cachedClearTimeout===clearTimeout)return clearTimeout(e);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(e);try{return cachedClearTimeout(e)}catch(t){try{return cachedClearTimeout.call(null,e)}catch(t){return cachedClearTimeout.call(this,e)}}}function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var e=runTimeout(cleanUpNextTick);draining=!0;for(var t=queue.length;t;){for(currentQueue=queue,queue=[];++queueIndex<t;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,t=queue.length}currentQueue=null,draining=!1,runClearTimeout(e)}}function Item(e,t){this.fun=e,this.array=t}function noop(){}var process=module.exports={},cachedSetTimeout,cachedClearTimeout;!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var queue=[],draining=!1,currentQueue,queueIndex=-1;process.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var u=1;u<arguments.length;u++)t[u-1]=arguments[u];queue.push(new Item(e,t)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.binding=function(e){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(e){throw new Error("process.chdir is not supported")},process.umask=function(){return 0};
},{}],24:[function(require,module,exports){
"function"==typeof Object.create?module.exports=function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(t,e){t.super_=e;var o=function(){};o.prototype=e.prototype,t.prototype=new o,t.prototype.constructor=t};
},{}],25:[function(require,module,exports){
module.exports=function(o){return o&&"object"==typeof o&&"function"==typeof o.copy&&"function"==typeof o.fill&&"function"==typeof o.readUInt8};
},{}],26:[function(require,module,exports){
(function (process,global){
function inspect(e,r){var t={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(t.depth=arguments[2]),arguments.length>=4&&(t.colors=arguments[3]),isBoolean(r)?t.showHidden=r:r&&exports._extend(t,r),isUndefined(t.showHidden)&&(t.showHidden=!1),isUndefined(t.depth)&&(t.depth=2),isUndefined(t.colors)&&(t.colors=!1),isUndefined(t.customInspect)&&(t.customInspect=!0),t.colors&&(t.stylize=stylizeWithColor),formatValue(t,e,t.depth)}function stylizeWithColor(e,r){var t=inspect.styles[r];return t?"["+inspect.colors[t][0]+"m"+e+"["+inspect.colors[t][1]+"m":e}function stylizeNoColor(e,r){return e}function arrayToHash(e){var r={};return e.forEach(function(e,t){r[e]=!0}),r}function formatValue(e,r,t){if(e.customInspect&&r&&isFunction(r.inspect)&&r.inspect!==exports.inspect&&(!r.constructor||r.constructor.prototype!==r)){var n=r.inspect(t,e);return isString(n)||(n=formatValue(e,n,t)),n}var i=formatPrimitive(e,r);if(i)return i;var o=Object.keys(r),s=arrayToHash(o);if(e.showHidden&&(o=Object.getOwnPropertyNames(r)),isError(r)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return formatError(r);if(0===o.length){if(isFunction(r)){var u=r.name?": "+r.name:"";return e.stylize("[Function"+u+"]","special")}if(isRegExp(r))return e.stylize(RegExp.prototype.toString.call(r),"regexp");if(isDate(r))return e.stylize(Date.prototype.toString.call(r),"date");if(isError(r))return formatError(r)}var c="",a=!1,l=["{","}"];if(isArray(r)&&(a=!0,l=["[","]"]),isFunction(r)){var p=r.name?": "+r.name:"";c=" [Function"+p+"]"}if(isRegExp(r)&&(c=" "+RegExp.prototype.toString.call(r)),isDate(r)&&(c=" "+Date.prototype.toUTCString.call(r)),isError(r)&&(c=" "+formatError(r)),0===o.length&&(!a||0==r.length))return l[0]+c+l[1];if(t<0)return isRegExp(r)?e.stylize(RegExp.prototype.toString.call(r),"regexp"):e.stylize("[Object]","special");e.seen.push(r);var f;return f=a?formatArray(e,r,t,s,o):o.map(function(n){return formatProperty(e,r,t,s,n,a)}),e.seen.pop(),reduceToSingleString(f,c,l)}function formatPrimitive(e,r){if(isUndefined(r))return e.stylize("undefined","undefined");if(isString(r)){var t="'"+JSON.stringify(r).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(t,"string")}return isNumber(r)?e.stylize(""+r,"number"):isBoolean(r)?e.stylize(""+r,"boolean"):isNull(r)?e.stylize("null","null"):void 0}function formatError(e){return"["+Error.prototype.toString.call(e)+"]"}function formatArray(e,r,t,n,i){for(var o=[],s=0,u=r.length;s<u;++s)hasOwnProperty(r,String(s))?o.push(formatProperty(e,r,t,n,String(s),!0)):o.push("");return i.forEach(function(i){i.match(/^\d+$/)||o.push(formatProperty(e,r,t,n,i,!0))}),o}function formatProperty(e,r,t,n,i,o){var s,u,c;if(c=Object.getOwnPropertyDescriptor(r,i)||{value:r[i]},c.get?u=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(u=e.stylize("[Setter]","special")),hasOwnProperty(n,i)||(s="["+i+"]"),u||(e.seen.indexOf(c.value)<0?(u=isNull(t)?formatValue(e,c.value,null):formatValue(e,c.value,t-1),u.indexOf("\n")>-1&&(u=o?u.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+u.split("\n").map(function(e){return"   "+e}).join("\n"))):u=e.stylize("[Circular]","special")),isUndefined(s)){if(o&&i.match(/^\d+$/))return u;s=JSON.stringify(""+i),s.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,"string"))}return s+": "+u}function reduceToSingleString(e,r,t){var n=0,i=e.reduce(function(e,r){return n++,r.indexOf("\n")>=0&&n++,e+r.replace(/\u001b\[\d\d?m/g,"").length+1},0);return i>60?t[0]+(""===r?"":r+"\n ")+" "+e.join(",\n  ")+" "+t[1]:t[0]+r+" "+e.join(", ")+" "+t[1]}function isArray(e){return Array.isArray(e)}function isBoolean(e){return"boolean"==typeof e}function isNull(e){return null===e}function isNullOrUndefined(e){return null==e}function isNumber(e){return"number"==typeof e}function isString(e){return"string"==typeof e}function isSymbol(e){return"symbol"==typeof e}function isUndefined(e){return void 0===e}function isRegExp(e){return isObject(e)&&"[object RegExp]"===objectToString(e)}function isObject(e){return"object"==typeof e&&null!==e}function isDate(e){return isObject(e)&&"[object Date]"===objectToString(e)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(e){return"function"==typeof e}function isPrimitive(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||"undefined"==typeof e}function objectToString(e){return Object.prototype.toString.call(e)}function pad(e){return e<10?"0"+e.toString(10):e.toString(10)}function timestamp(){var e=new Date,r=[pad(e.getHours()),pad(e.getMinutes()),pad(e.getSeconds())].join(":");return[e.getDate(),months[e.getMonth()],r].join(" ")}function hasOwnProperty(e,r){return Object.prototype.hasOwnProperty.call(e,r)}var formatRegExp=/%[sdj%]/g;exports.format=function(e){if(!isString(e)){for(var r=[],t=0;t<arguments.length;t++)r.push(inspect(arguments[t]));return r.join(" ")}for(var t=1,n=arguments,i=n.length,o=String(e).replace(formatRegExp,function(e){if("%%"===e)return"%";if(t>=i)return e;switch(e){case"%s":return String(n[t++]);case"%d":return Number(n[t++]);case"%j":try{return JSON.stringify(n[t++])}catch(e){return"[Circular]"}default:return e}}),s=n[t];t<i;s=n[++t])o+=isNull(s)||!isObject(s)?" "+s:" "+inspect(s);return o},exports.deprecate=function(e,r){function t(){if(!n){if(process.throwDeprecation)throw new Error(r);process.traceDeprecation?console.trace(r):console.error(r),n=!0}return e.apply(this,arguments)}if(isUndefined(global.process))return function(){return exports.deprecate(e,r).apply(this,arguments)};if(process.noDeprecation===!0)return e;var n=!1;return t};var debugs={},debugEnviron;exports.debuglog=function(e){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),e=e.toUpperCase(),!debugs[e])if(new RegExp("\\b"+e+"\\b","i").test(debugEnviron)){var r=process.pid;debugs[e]=function(){var t=exports.format.apply(exports,arguments);console.error("%s %d: %s",e,r,t)}}else debugs[e]=function(){};return debugs[e]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=require("./support/isBuffer");var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))},exports.inherits=require("inherits"),exports._extend=function(e,r){if(!r||!isObject(r))return e;for(var t=Object.keys(r),n=t.length;n--;)e[t[n]]=r[t[n]];return e};
}).call(this,require('_process'),typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})

},{"./support/isBuffer":25,"_process":23,"inherits":24}],27:[function(require,module,exports){
function OmsOplogSubscriptions(o){var t=this;t.opLogCollection=o,t.docCollection=o.docCollection,t._subscriptions={},t._collectionQueries={},t._opLogQueries={},this.opLogCollection.on("insert",function(o){t._publish(o)})}var OmsSubscriptions=require("./OmsSubscriptions"),OmsUtils=require("./OmsUtils");OmsOplogSubscriptions.prototype.subscribeResume=function(o,t,e,i){var r=this;r.opLogCollection.findOne({_id:o},function(s,n){function u(){null==c?r.subscribe(t,e,i):r.opLogCollection.findOne({_id:c.data},function(o,s){if(o)i(o,null);else{var n=r.opLogSubscriptionComputedDoc(s,e,t);null!=n&&i(null,n),c=c.next,u()}})}if(s&&i(s,null),null==n)i("last_op_not_found",null);else{var c=r.opLogCollection.docsLinkedList.list[o];c=c.next,u()}})},OmsOplogSubscriptions.prototype.opLogSubscriptionComputedDoc=function(o,t,e){return OmsUtils.docMatch(o,t)?this.operationSubscriptionComputedDoc(o,e):null},OmsOplogSubscriptions.prototype.operationSubscriptionComputedDoc=function(o,t){switch(o.operation.operation){case"insert":case"remove":if(OmsUtils.docMatch(o.operation.doc,t))return this._objectMerge(o,{src:"subscription"});break;case"update":var e=OmsUtils.docMatch(o.operation.unmodifiedDoc,t),i=OmsUtils.docMatch(o.operation.modifiedDoc,t);if(e&&i)return o;if(e&&!i){OmsUtils.operationObject("remove",[o.operation.unmodifiedDoc])}else{if(e||!i)return null;OmsUtils.operationObject("insert",[o.operation.modifiedDoc])}return this._objectMerge(operationDoc,{_srcOpId:o._id,src:"subscription_translated"});default:throw new Error("unknown_event")}return null},OmsOplogSubscriptions.prototype.findSubscribe=function(o,t,e){function i(){s&&e.apply(r,Array.prototype.slice.call(arguments))}var r=this,s=!1,n=r.subscribe(o,t,i);return r.docCollection.find(o,function(o,t){o?e(o,null):(s=!0,t.forEach(function(o){var t=OmsUtils.operationObject("insert",[o]),i=r._objectMerge(OmsUtils.operationDoc(t),{src:"subscription_setup"});e(null,i)}))}),n},OmsOplogSubscriptions.prototype.subscribe=function(o,t,e){var i=this._queryKey(this._collectionQueries,o);this._collectionQueries[i].usages++;var r=this._queryKey(this._opLogQueries,t);this._opLogQueries[r].usages++;var s=this._uniqueId();return this._subscriptions[s]={collectionQueryKey:i,opLogQueryKey:r,callback:e},s},OmsOplogSubscriptions.prototype._publish=function(o){var t=this,e={},i={};this._objectForEach(t._subscriptions,function(r,s){var n=r.collectionQueryKey,u=t._collectionQueries[n].query,c=r.opLogQueryKey,p=t._opLogQueries[c].query;"boolean"!=typeof i[c]&&(i[c]=OmsUtils.docMatch(o,p)),i[c]&&("boolean"!=typeof e[n]&&(e[n]=t.operationSubscriptionComputedDoc(o,u)),null!=e[n]&&r.callback(null,e[n]))})},OmsOplogSubscriptions.prototype._queryKey=function(o,t){var e;for(e in o)if(o.hasOwnProperty(e)&&this._objectDeepEqual(o[e].query,t))return e;var i=this._uniqueId();return o[i]={usages:0,query:t},i},OmsOplogSubscriptions.prototype.unsubscribe=function(o){var t=this._subscriptions[o];if(!t)throw new Error("subscription_not_found");var e=t.collectionQueryKey,i=this._collectionQueries[e];i.usages--,i.usages<=0&&delete this._collectionQueries[e];var r=t.opLogQueryKey,s=this._opLogQueries[r];s.usages--,s.usages<=0&&delete this._opLogQueries[r]},OmsOplogSubscriptions.prototype._uniqueId=function(){function o(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return o()+o()+"-"+o()+"-"+o()+"-"+o()+"-"+o()+o()+o()},OmsOplogSubscriptions.prototype._objectDeepEqual=function(o,t){if("object"==typeof o&&null!=o&&"object"==typeof t&&null!=t){if(Object.keys(o).length!=Object.keys(t).length)return!1;for(var e in o){if(!t.hasOwnProperty(e))return!1;if(!this._objectDeepEqual(o[e],t[e]))return!1}return!0}return o===t},OmsOplogSubscriptions.prototype._objectForEach=function(o,t){var e;for(e in o)o.hasOwnProperty(e)&&t(o[e],e,o)},OmsOplogSubscriptions.prototype._objectMerge=function(){var o={};return this._objectForEach(arguments,function(t){for(var e in t)t.hasOwnProperty(e)&&(o[e]=t[e])}),o},module.exports=function(o){return new OmsOplogSubscriptions(o)};
},{"./OmsSubscriptions":28,"./OmsUtils":29}],28:[function(require,module,exports){
function OmsSubscriptions(t){this.opLogSubscriptions=t}var OmsUtils=require("./OmsUtils");OmsSubscriptions.prototype.findSubscribeObject=function(){var t="function"==typeof arguments[1]?arguments[0]:{},i="function"==typeof arguments[0]?arguments[0]:arguments[1];return this.opLogSubscriptions.findSubscribe(t,{},function(t,n){t?i(t):i(t,n.type,n.operation)})},OmsSubscriptions.prototype.subscribeObject=function(){var t="function"==typeof arguments[1]?arguments[0]:{},i="function"==typeof arguments[0]?arguments[0]:arguments[1];return this.opLogSubscriptions.subscribe(t,{},function(t,n){t?i(t):i(t,n.operation)})},OmsSubscriptions.prototype.findSubscribe=function(){var t="function"==typeof arguments[0]?{}:arguments[0],i="function"==typeof arguments[0]?arguments[0]:arguments[1];return this.findSubscribeObject(t,function(t,n){t?i(t):i.apply(this,[t,n.operation].concat(OmsUtils.operationFunctionArguments(n)))})},OmsSubscriptions.prototype.subscribe=function(){var t="function"==typeof arguments[0]?{}:arguments[0],i="function"==typeof arguments[0]?arguments[0]:arguments[1];return this.subscribeObject(t,function(t,n){t?i(t):i.apply(this,[t,n.operation].concat(OmsUtils.operationFunctionArguments(n)))})},OmsSubscriptions.prototype.unsubscribe=function(t){return this.opLogSubscriptions.unsubscribe(t)},module.exports=function(t){return new OmsSubscriptions(t)};
},{"./OmsUtils":29}],29:[function(require,module,exports){
var FauxMongo=require("fauxmongo"),OmsUtils={};OmsUtils.docMatch=function(o,t){return FauxMongo.matchQuery(o,t)},OmsUtils.operationFunctionArguments=function(o){switch(o.operation){case"insert":return[o.doc,o.options];case"update":return[{_id:o.unmodifiedDoc._id},o.updateOperation,o.options];case"remove":return[{_id:o.doc._id},o.options];default:throw new Error("undefined_operation_type")}},OmsUtils.operationDoc=function(o){return{date:new Date,operation:o}},OmsUtils.operationDocMin=function(o){return{_id:o._id,operation:OmsUtils.operationObjectMin(o.operation)}},OmsUtils.operationObjectMin=function(o){switch(o.operation){case"insert":return o;case"remove":return{operation:o.operation,doc:{_id:o.doc._id},options:o.options};case"update":return{operation:o.operation,unmodifiedDoc:{_id:o.unmodifiedDoc._id},updateOperation:o.updateOperation,options:o.options}}},OmsUtils.operationObject=function(o,t){switch(o){case"insert":case"remove":return{operation:o,doc:t[0],options:"object"!=typeof t[1]&&null==t[1]?{}:t[1]};case"update":return{operation:o,unmodifiedDoc:t[0],modifiedDoc:t[1],updateOperation:t[2],options:"object"!=typeof t[3]&&null==t[3]?{}:t[3]};default:throw new Error("undefined_operation_type")}},module.exports=OmsUtils;
},{"fauxmongo":4}]},{},[27])(27)
});


//# sourceMappingURL=omsoplogsubscriptions.js.map